# ğŸ¤– SAVAGE Chatbot - Diagrama de Flujo de Estados

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WHATSAPP CLOUD API                                â”‚
â”‚              (Webhook â†’ Supabase Edge Function)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EDGE FUNCTION: whatsapp-bot                          â”‚
â”‚                                                                      â”‚
â”‚   1. Recibir POST del Webhook                                        â”‚
â”‚   2. Validar firma (HMAC SHA256)                                     â”‚
â”‚   3. Extraer: phone_number, message_text                             â”‚
â”‚   4. Consultar bot_sessions â†’ Estado del usuario                     â”‚
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚              MÃQUINA DE ESTADOS                         â”‚        â”‚
â”‚   â”‚                                                         â”‚        â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Nuevo     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚        â”‚
â”‚   â”‚  â”‚  (null)   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  welcome     â”‚              â”‚        â”‚
â”‚   â”‚  â”‚ Sin sesiÃ³nâ”‚            â”‚ MenÃº inicial â”‚              â”‚        â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚        â”‚
â”‚   â”‚                                  â”‚                      â”‚        â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚        â”‚
â”‚   â”‚              â”‚                   â”‚              â”‚       â”‚        â”‚
â”‚   â”‚              â–¼                   â–¼              â–¼       â”‚        â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
â”‚   â”‚   â”‚  "1..N"        â”‚  â”‚    "0"       â”‚  â”‚  "?"     â”‚   â”‚        â”‚
â”‚   â”‚   â”‚ Elige CategorÃ­aâ”‚  â”‚ Pide Asesor  â”‚  â”‚ InvÃ¡lido â”‚   â”‚        â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚        â”‚
â”‚   â”‚           â”‚                   â”‚                â”‚        â”‚        â”‚
â”‚   â”‚           â–¼                   â–¼                â–¼        â”‚        â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
â”‚   â”‚   â”‚ category_browseâ”‚  â”‚   human      â”‚  â”‚ welcome  â”‚   â”‚        â”‚
â”‚   â”‚   â”‚ Lista 5 prods  â”‚  â”‚ Bot se calla â”‚  â”‚ ReenvÃ­a  â”‚   â”‚        â”‚
â”‚   â”‚   â”‚ + links web    â”‚  â”‚ Manual reply â”‚  â”‚ el menÃº  â”‚   â”‚        â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚
â”‚   â”‚           â”‚                                              â”‚        â”‚
â”‚   â”‚           â–¼                                              â”‚        â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚        â”‚
â”‚   â”‚   â”‚  "menu"        â”‚â—„â”€â”€ DespuÃ©s de ver productos        â”‚        â”‚
â”‚   â”‚   â”‚  Vuelve a menÃº â”‚    el usuario puede seguir         â”‚        â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    navegando                       â”‚        â”‚
â”‚   â”‚                                                         â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## Estados de SesiÃ³n (bot_sessions.state)

| Estado              | DescripciÃ³n                                   | AcciÃ³n del Bot                              |
|---------------------|-----------------------------------------------|---------------------------------------------|
| `welcome`           | Primera interacciÃ³n o menÃº principal           | EnvÃ­a menÃº numÃ©rico con categorÃ­as          |
| `category_browse`   | El usuario eligiÃ³ una categorÃ­a                | Lista 5 productos + enlaces al frontend     |
| `human`             | El usuario pidiÃ³ asesor (opciÃ³n 0)             | Bot ignora mensajes, atenciÃ³n manual        |
| `null` (sin sesiÃ³n) | Primer contacto absoluto                       | Crea sesiÃ³n â†’ estado `welcome`              |

## Flujo de Mensajes

```
USUARIO                          BOT
  â”‚                                â”‚
  â”‚  "Hola" (primer contacto)     â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                â”‚â”€â”€â”€ Crea sesiÃ³n (state: welcome)
  â”‚  ğŸ† SAVAGE STORE ğŸ†           â”‚
  â”‚  ElegÃ­ una opciÃ³n:            â”‚
  â”‚  1. CAMISETAS-PLAYER          â”‚
  â”‚  2. CAMISETAS-FAN             â”‚
  â”‚  3. CALZADO                   â”‚
  â”‚  0. ğŸ’¬ Hablar con un asesor   â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                â”‚
  â”‚  "2"                           â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                â”‚â”€â”€â”€ state â†’ category_browse
  â”‚  âš½ CAMISETAS-FAN             â”‚
  â”‚                                â”‚
  â”‚  1ï¸âƒ£ JapÃ³n x Zoro              â”‚
  â”‚  Gs. 180,000                   â”‚
  â”‚  ğŸ”— Ver: savageeepy.com/...   â”‚
  â”‚                                â”‚
  â”‚  2ï¸âƒ£ Cerro PorteÃ±o Alt 2025   â”‚
  â”‚  Gs. 50,000 (OFERTA -50%)     â”‚
  â”‚  ğŸ”— Ver: savageeepy.com/...   â”‚
  â”‚  ...                           â”‚
  â”‚                                â”‚
  â”‚  EscribÃ­ *menu* para volver    â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                â”‚
  â”‚  "0"                           â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                â”‚â”€â”€â”€ state â†’ human
  â”‚  Un asesor te atenderÃ¡ pronto â”‚
  â”‚  â° Horario: 9:00-20:00       â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                â”‚
  â”‚  "Quiero la talla M"          â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                â”‚â”€â”€â”€ (Bot ignora, state = human)
  â”‚                                â”‚â”€â”€â”€ Asesor responde manualmente
```

## Instagram / TikTok Redirect (social-redirect)

```
USUARIO (DM Instagram/TikTok)     EDGE FUNCTION
  â”‚                                â”‚
  â”‚  "Hola, precio?"               â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                â”‚
  â”‚  Â¡Hola! ğŸ‘‹ Gracias por tu     â”‚
  â”‚  mensaje. Para una atenciÃ³n   â”‚
  â”‚  mÃ¡s rÃ¡pida y personalizada,  â”‚
  â”‚  escribinos por WhatsApp:     â”‚
  â”‚  ğŸ“± wa.me/595XXXXXXXXX        â”‚
  â”‚                                â”‚
  â”‚  TambiÃ©n podÃ©s ver todo       â”‚
  â”‚  nuestro catÃ¡logo en:         â”‚
  â”‚  ğŸŒ www.savageeepy.com        â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

## Variables de Entorno Requeridas

| Variable                    | DescripciÃ³n                          |
|-----------------------------|--------------------------------------|
| `WHATSAPP_VERIFY_TOKEN`     | Token de verificaciÃ³n del webhook    |
| `WHATSAPP_ACCESS_TOKEN`     | Token de acceso a WhatsApp Cloud API |
| `WHATSAPP_PHONE_NUMBER_ID`  | Phone Number ID de la API            |
| `DB_URL`                    | URL de Supabase                      |
| `PRIVATE_KEY`               | Service Role Key de Supabase         |
| `FRONTEND_URL`              | https://www.savageeepy.com           |
